var me=Object.defineProperty,pe=Object.defineProperties;var de=Object.getOwnPropertyDescriptors;var te=Object.getOwnPropertySymbols;var fe=Object.prototype.hasOwnProperty,he=Object.prototype.propertyIsEnumerable;var ne=(n,l,u)=>l in n?me(n,l,{enumerable:!0,configurable:!0,writable:!0,value:u}):n[l]=u,k=(n,l)=>{for(var u in l||(l={}))fe.call(l,u)&&ne(n,u,l[u]);if(te)for(var u of te(l))he.call(l,u)&&ne(n,u,l[u]);return n},V=(n,l)=>pe(n,de(l));var U=(n,l,u)=>new Promise((x,b)=>{var T=w=>{try{v(u.next(w))}catch(R){b(R)}},g=w=>{try{v(u.throw(w))}catch(R){b(R)}},v=w=>w.done?x(w.value):Promise.resolve(w.value).then(T,g);v((u=u.apply(n,l)).next())});import{B as ge}from"./BasicTable.ebe28ef2.js";import{o as we,w as oe,s as xe}from"./componentMap.801737ea.js";import"./TableImg.a4c65e1f.js";import{u as ye}from"./useTable.db680d93.js";import{b as ve,bO as Ce,z as K,B as W,T as le,ec as Se,a0 as H,a as Fe,dw as be,bw as Te,j as _,by as D,aw as Oe,an as Re,de as Be,d0 as Ne,eS as _e,h as $,eV as Ae,U as ke,o as z,k as Y,G,J as re,t as se,l as Je,i as Ie,a9 as $e,N as Pe,b6 as Ee}from"./index.0c676cb0.js";import{e as De,h as Ke,i as Le}from"./dynamicReportConfig.data.f9d0c71a.js";import{f as q}from"./index.e3d374a0.js";import{s as Me,a as ae}from"./onlineNew.7fc4ec7d.js";import{a as je}from"./download.2d6dcb07.js";import"./BasicForm.7ed18e1d.js";import"./FormItem.vue_vue_type_script_lang.3f5bf9fa.js";import"./index.7aa87f83.js";import"./BasicModal.6a1e781a.js";import"./useWindowSizeFn.f69fad46.js";import"./useForm.f6b94960.js";import"./RadioButtonGroup.dc9fedf3.js";import"./useFormItem.47fc2179.js";import"./JDictSelectTag.b196d7c6.js";import"./JUpload.2c84d159.js";import"./api.6d7ba78d.js";import"./functional.51da07bc.js";import"./index.7910eff5.js";import"./onMountedOrActivated.29514295.js";import"./useContentViewHeight.3c3f37af.js";import"./FormOutlined.f1bb593e.js";import"./useSortable.29b10662.js";import"./index.95c15ee4.js";import"./index.b5b26116.js";import"./index.32a34a9d.js";import"./useCountdown.df5930af.js";import"./props.acb18fde.js";import"./Tree.vue_vue_type_style_index_0_lang.9a87433c.js";import"./useContextMenu.8ed3a346.js";import"./index.008cf2db.js";import"./index.a5c5d78d.js";import"./htmlmixed.604e57c2.js";import"./vue.1c47a5ee.js";import"./depart.api.904c0734.js";import"./index.ea661fe9.js";import"./EditOutlined.7e0ce9a3.js";import"./base64Conver.bb012c73.js";const{handleExportXls:Ve,handleImportXls:qe}=we();function Xe(n){const l=le();let u={};n.designScope&&(u=ve(n.designScope));const x=ze(n.tableProps),[,{getForm:b,reload:T,setLoading:g},{selectedRowKeys:v}]=x;function w(){return U(this,null,function*(){var N;let{url:B,name:f,params:J}=(N=n==null?void 0:n.exportConfig)!=null?N:{};if(B){let I=typeof f=="function"?f():f,F=yield b().validate();const L=b().getFieldsValue();return F=Object.assign({},F,L),J&&(F=Object.assign({},F,J)),v.value&&v.value.length>0&&(F.selections=v.value.join(",")),Ve(I,B,Se(F))}else return l.createMessage.warn("\u6CA1\u6709\u4F20\u9012 exportConfig.url \u53C2\u6570"),Promise.reject()})}function R(B){var N;let{url:f,success:J}=(N=n==null?void 0:n.importConfig)!=null?N:{};return f?qe(B,f,J||T):(l.createMessage.warn("\u6CA1\u6709\u4F20\u9012 importConfig.url \u53C2\u6570"),Promise.reject())}function P(B,f){return new Promise((J,N)=>{var F;const I=()=>U(this,null,function*(){var L,X;try{g(!0);const M=yield B();((L=f==null?void 0:f.reload)==null||L)&&T(),((X=f==null?void 0:f.clearSelection)==null||X)&&(v.value=[]),J(M)}catch(M){N(M)}finally{g(!1)}});(F=f==null?void 0:f.confirm)==null||F?l.createConfirm({iconType:"warning",title:"\u5220\u9664",content:"\u786E\u5B9A\u8981\u5220\u9664\u5417\uFF1F",onOk:()=>I(),onCancel:()=>N()}):I()})}function y(B){return P(B,{confirm:!1,clearSelection:!1})}return V(k(k({},u),l),{onExportXls:w,onImportXls:R,doRequest:P,doDeleteRecord:y,tableContext:x})}function ze(n){var w,R,P;const l={xs:24,sm:12,md:12,lg:8,xl:8,xxl:6},u={rowKey:"id",useSearchForm:!0,formConfig:{compact:!0,labelWidth:120,autoSubmitOnEnter:!0,rowProps:{gutter:8},baseColProps:k({},l),labelCol:{xs:24,sm:8,md:6,lg:8,xl:6,xxl:6},wrapperCol:{},showAdvancedButton:!0,autoAdvancedCol:3,actionColOptions:V(k({},l),{style:{textAlign:"left"}})},striped:!0,canResize:!0,minHeight:500,clickToRowSelect:!1,bordered:!0,showIndexColumn:!1,showTableSetting:!0,tableSetting:{fullScreen:!0},showActionColumn:!0};n&&Ce(u,n);function x(y){return Object.assign({column:"id",order:"asc"},y)}Object.assign(u,{beforeFetch:x}),typeof n.beforeFetch=="function"&&(u.beforeFetch=function(y){return y=x(y),n.beforeFetch(y),y});const b=K([]),T=K([]),g=(w=n==null?void 0:n.rowSelection)!=null?w:{},v=W(V(k({},g),{type:(R=g.type)!=null?R:"checkbox",columnWidth:(P=g.columnWidth)!=null?P:50,selectedRows:T,selectedRowKeys:b,onChange(...y){b.value=y[0],T.value=y[1],typeof g.onChange=="function"&&g.onChange(...y)}}));return delete u.rowSelection,[...ye(u),{selectedRows:T,selectedRowKeys:b,rowSelection:v}]}const He=n=>H.get({url:`/report/api/getQueryInfo/${n}`}),Ue=n=>H.get({url:`/report/api/getColumnsAndData/${n}`}),Ye=n=>l=>H.get({url:`/report/api/getData/${n}`,params:l}),Ge=n=>`/report/api/exportXls/${n}`,Kt=Fe({__name:"preview",setup(n){const l=K(!0),{setTitle:u}=be(),{currentRoute:x}=Te(),{createMessage:b}=le(),T=K([]),g=[],v=K("\u5BFC\u51FA"),w=W({name:"",url:Ge(_(x).params.id),params:{}}),{tableContext:R,onExportXls:P}=Xe({designScope:"auto-online-preview",tableProps:{columns:[],formConfig:{schemas:[],showAdvancedButton:!1,showActionButtonGroup:!1}},exportConfig:w}),[y,{setProps:B,reload:f,getForm:J},{rowSelection:N,selectedRowKeys:I}]=R;Promise.all([He(_(x).params.id),De({headId:_(x).params.id}),Ue(_(x).params.id)]).then(([e,a,p])=>{const{columns:t,dictOptions:c,fieldFilterSlots:h,fieldHrefSlots:i,configJson:s}=p,m=s?JSON.parse(s.replace(/\s*/g,"")):{};l.value=m.export!==!1,v.value=m.exportBtnName||"\u5BFC\u51FA",w.name=m.exportFileName||"\u5BFC\u51FA\u6587\u4EF6";let C=[],O=t?t.map(o=>{const r=o.customRender,A={init:!1,show:!1};return o.isTotal==="1"&&C.push(o.dataIndex),o.customRender=E=>ue(E,oe.exports.merge({},o,{customRender:r}),{dictOptions:c,fieldFilterSlots:h,fieldHrefSlots:i},A),o}):[],d=ie(e,c);if(a&&a.length){const o=a.filter(r=>(r.extendJson?JSON.parse(r.extendJson.replace(/\s*/g,"")):{}).position!=="tool").map(r=>(r.loading=K(!1),r));T.value=a.filter(r=>(r.extendJson?JSON.parse(r.extendJson.replace(/\s*/g,"")):{}).position==="tool").map(r=>(r.onclick=()=>M(r,e),r.loading=K(!1),r)),o.length&&d.push({field:"customBtn",component:"Input",renderColContent:function(){return o.map(r=>D(Oe,{type:"primary",loading:r.loading,style:"margin-left: 15px",onclick:()=>M(r,e)},[r.btnName]))}})}O=xe(O),d.map(o=>{o.component==="RangePicker"&&g.push([o.field,[`${o.field}_begin`,`${o.field}_end`],o.componentProps&&o.componentProps.valueFormat?o.componentProps.valueFormat:"YYYY-MM-DD"])}),g&&g.length&&g.map(o=>{const r=o[0];r&&(w.params[r]=void 0)}),B({api:Ye(_(x).params.id),canResize:!0,columns:O,beforeFetch:function(o){return F(o,e)},useSearchForm:!!d.length,formConfig:{schemas:d,labelAlign:"right",layout:"horizontal",labelCol:Me,baseColProps:ae,actionColOptions:V(k({},ae),{style:{textAlign:"left",paddingLeft:"10px"}}),showAdvancedButton:!0,showActionButtonGroup:!0,autoAdvancedCol:3,fieldMapToTime:g},showSummary:C.length>0,summaryFunc:o=>X(o,C)}),Re(()=>{f()})}),L();function F(e,a){e=e||{};const t=J().getFieldsValue(),c=_(x).query;e=oe.exports.merge({},c,t,e);const h=g.map(i=>i[0]?i[0]:"");return Object.keys(e).map(i=>{const s=a.find(m=>m.field===i)||{};if((e[i]===""||e[i]===null)&&(e[i]=void 0),(s.view==="Number"||s.view==="Long"||s.view==="Time")&&s.mode==="group"){const m=e[i]?e[i].split(","):[];e[`${i}_begin`]=m[0]||void 0,e[`${i}_end`]=m[1]||void 0,e[i]=void 0}h.indexOf(i)!==-1&&(e[i]=void 0)}),e}function L(){Be().then(e=>{const a=x.value.path,p=Ne(e,a),t=e.filter(h=>h.path===p[0]),c=t&&t.length?t[0]:{};if(c.children&&c.children.length){const h=c.children.find(i=>i.path===a);h&&u(h.name)}})}function X(e,a){return[_e(e,a)]}function M(e,a){const p=e==null?void 0:e.callType,t=e==null?void 0:e.method,c=e==null?void 0:e.url;e.loading&&(e.loading.value=!0);const h=e!=null&&e.params?JSON.parse(e==null?void 0:e.params):{};I.value&&I.value.length>0&&(h.selections=I.value.join(","));const i={url:c,params:F(h,a)};(p==="zip"||p==="execl")&&(i.responseType="blob"),H[t](i,{isReturnNativeResponse:!0}).then(s=>{if(p==="execl"||p==="zip"){const C=(s.headers||{})["content-disposition"]||"",O=/filename=(.*)[;]?$/,d=C.match(O);let o="";d!=null&&d[1]&&(o=d[1].replace(/['"]/g,""),o=decodeURIComponent(o));const r=s.data;if(!r){b.warning("\u6587\u4EF6\u4E0B\u8F7D\u5931\u8D25");return}je(r,o)}else f();e.loading&&(e.loading.value=!1)}).catch(s=>{console.error(s),e.loading&&(e.loading.value=!1)})}function ie(e,a){return(e||[]).map(t=>{var O;const c=Ke.find(d=>d.value===t.contrType),h=Le.find(d=>d.value===t.view),i=c||h||{},s=t.extendJson?JSON.parse(t.extendJson.replace(/\s*/g,"")):{};let m=(O=i.componentProps)!=null?O:{},C=i.component||"";if(a&&a[t.field]&&(m.options=a[t.field]),t.contrType==="text")m.maxlength=s.maxlength,m.type=s.type;else if(t.contrType==="sel_user")m.rowKey=s.store,m.labelKey=s.text;else if(t.contrType==="sel_depart"){const d=s.multiSelect===!0||s.multiSelect==="true";m.rowKey=s.store,m.multiple=d}else t.contrType==="next_custom_select"?(C="NextCustomSelect",m=({formModel:d})=>{const o=s.syncForm?k({},s.syncForm):{};return Object.keys(o).map(r=>{s[`onUpdate:${r}`]=A=>{d[o[r]]=A}}),k({},s)}):(t.view==="Number"||t.view==="Long")&&t.mode==="group"?C="NextNumberRange":(t.view==="Date"||t.view==="Datetime"||t.view==="Time"||t.contrType==="date"||t.contrType==="datatime"||t.contrType==="time")&&t.mode==="group"&&(C="RangePicker",(t.contrType==="datatime"||t.view==="Datetime")&&(m.showTime=!0),m.ranges={\u672C\u5468:[$().startOf("week"),$().endOf("week")],\u672C\u6708:[$().startOf("month"),$().endOf("month")],\u672C\u5B63\u5EA6:[$().startOf("quarter"),$().endOf("quarter")],\u672C\u5E74:[$().startOf("year"),$().endOf("year")]});return{label:t.label,field:t.field,colProps:{span:6},searchSortNum:t.searchSortNum,component:C,defaultValue:s.defaultValue?s.defaultValue:void 0,componentProps:m}}).sort((t,c)=>((t==null?void 0:t.searchSortNum)||0)-((c==null?void 0:c.searchSortNum)||0))}function ue(e,a,p,t){let c=e!=null&&e.text?e==null?void 0:e.text:(e==null?void 0:e.text)===0?0:"";const h=(a==null?void 0:a.customRender)||"",i=(a==null?void 0:a.hrefSlotName)||"",s=(a==null?void 0:a.filterSlotName)||"",m=(p==null?void 0:p.dictOptions)||{},C=(p==null?void 0:p.fieldHrefSlots)||[],O=(p==null?void 0:p.fieldFilterSlots)||[];let d="",o="",r=!1,A="";const E=W({show:!1});t.init&&(E.show=t.show);function ce(){t.init=!0,t.show=!t.show,E.show=!E.show}function Q(S){return S?D(Ee,{icon:E.show?"ant-design:eye-invisible-outlined":"ant-design:eye-outlined",style:"paddingLeft: 10px;cursor: pointer",onClick:ce}):null}function Z(S,j,ee){return!E.show&&S?S(ee,j):ee}if(h&&m[h]&&(c=Ae(m[h],c)),i&&C){const S=C.find(j=>j.slotName===i);S&&(d=S.href||"")}if(s&&O){const S=O.find(j=>j.slotName===s);S&&(o=S.filterType||"",r=S.recovery==="true"||S.recovery===!0,A=S.wildcard||"")}return d&&q[o]?D("div",{},[D("a",{href:d,target:"_blank"},Z(q[o],A,c)),Q(r)]):!d&&q[o]?D("p",{},[D("span",{},Z(q[o],A,c)),Q(r)]):d&&!q[o]?D("a",{href:d,target:"_blank"},[c]):c}return(e,a)=>{const p=ke("a-button");return z(),Y(_(ge),{onRegister:_(y),rowSelection:_(N)},{tableTitle:G(()=>[l.value?(z(),Y(p,{key:0,type:"primary",preIcon:"ant-design:export-outlined",onClick:_(P)},{default:G(()=>[re(se(v.value),1)]),_:1},8,["onClick"])):Je("",!0),(z(!0),Ie(Pe,null,$e(T.value,(t,c)=>(z(),Y(p,{type:"primary",key:c,loading:t.loading,onClick:h=>t.onclick()},{default:G(()=>[re(se(t.btnName),1)]),_:2},1032,["loading","onClick"]))),128))]),_:1},8,["onRegister","rowSelection"])}}});export{Kt as default};
